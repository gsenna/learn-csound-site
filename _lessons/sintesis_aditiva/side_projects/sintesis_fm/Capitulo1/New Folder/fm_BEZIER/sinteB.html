
<!DOCTYPE HTML PUBLIC "-//IETF//DTD HTML//EN">
<html> <head>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8">
<title>Sliders</title>
<style>
#figure1 {
  border: 1px solid black;
}

.draggable {
  cursor: move;
}

.control-point {
  opacity: 0.5;
  stroke: none;
  fill: red;
}
</style>
</head>


<body style="margin:0; text-align:center;">

<div id="synth"> 
  <p>
    <input type="range" name="I" id="I" step="0.01" value="0" min="0" max="100" style="width: 100%;"
           oninput="IOut.value = I.value"> I - 
    <output name="IOut" id="IOut">0</output>
  </p>
  <p>
    <input type="range" name="fm" id="fm" step="0.01" value="5" min="0" max="8000" style="width: 100%;"
           oninput="fmOut.value = fm.value"> f<sub>m</sub> - 
    <output name="fmOut" id="fmOut">5</output> Hz
  </p>
  <p>
<button onclick="pause()">NOTA</button>
  </p>
  <p>
    <input type="range" name="amp" id="amp" step="0.01" value="0.5" min="0" max="1" style="width: 100%;"
           oninput="ampOut.value = amp.value"> Amp - 
    <output name="ampOut" id="ampOut">0.5</output>
  </p>
  <p>
    <input type="range" name="fc" id="fc" step="0.01" value="440" min="20" max="8000" style="width: 100%;"
           oninput="fcOut.value = fc.value"> f<sub>c</sub> - 
    <output name="fcOut" id="fcOut">440</output> Hz
  </p>
</div>
<div>
 <svg id="figure1" width="300" height="300" >
  <path d="M0 150 20 110 300 150" stroke="black" fill="none" id="controlPath"/>
  <path d="M0 150Q20 110 300 150" stroke="green" fill="none" id="curve"/>
  <circle cx="0" cy="150" r="8" id="p1" class="control-point draggable"/>
  <circle cx="20" cy="110" r="8" id="p2" class="control-point draggable"/>
  <circle cx="300" cy="150" r="8" id="p3" class="control-point draggable"/>
 </svg>
</div> 
<div>
    <canvas id='scope' width=200 height=80></canvas>
    <canvas id='spectrum' width=200 height=80></canvas>
</div>


<script>
var controlPath = document.getElementById('controlPath');
var curve = document.getElementById('curve');
var p1 = document.getElementById('p1');
var p2 = document.getElementById('p2');
var p3 = document.getElementById('p3');
var dragElem = null;

var svg = document.getElementById('figure1');
svg.addEventListener('mousemove', onMouseMove);
svg.addEventListener('mouseup', onMouseUp);

var elements = [p1, p2, p3];
for (i = 0; i < elements.length; i++) {
  elements[i].addEventListener('mousedown', onMouseDown);
}

var mouseOffsetX, mouseOffsetY;

function getClientPointInSVG(ev) {
  var p, m;

  p = svg.createSVGPoint();
  p.x = ev.clientX;
  p.y = ev.clientY;

  m = dragElem.getScreenCTM();
  return p.matrixTransform(m.inverse());
}

function onMouseDown(ev) {
  var p;

  dragElem = ev.target;
  p = getClientPointInSVG(ev);
  mouseOffsetX = p.x - dragElem.getAttribute('cx');
  mouseOffsetY = p.y - dragElem.getAttribute('cy');
}

function onMouseMove(ev) {
  var p;

  if (!dragElem) {
    return;
  }

  p = getClientPointInSVG(ev);
  dragElem.setAttribute('cx', p.x - mouseOffsetX);
  dragElem.setAttribute('cy', p.y - mouseOffsetY);

  controlPath.setAttribute('d',
    'M' + p1.getAttribute('cx') + ' ' + p1.getAttribute('cy') +
    ' ' + p2.getAttribute('cx') + ' ' + p2.getAttribute('cy') +
    ' ' + p3.getAttribute('cx') + ' ' + p3.getAttribute('cy'));
if (window.parent.csound.started != false)
{    
  window.parent.csound.Csound.setTable(2,0, p1.getAttribute('cx')/300);
  window.parent.csound.Csound.setTable(2,1, p1.getAttribute('cy')/300);
  window.parent.csound.Csound.setTable(2,2, p2.getAttribute('cx')/300);
  window.parent.csound.Csound.setTable(2,3, p2.getAttribute('cy')/300);
  window.parent.csound.Csound.setTable(2,4, p3.getAttribute('cx')/300);
  window.parent.csound.Csound.setTable(2,5, p3.getAttribute('cy')/300);
}
  curve.setAttribute('d',
    'M' + p1.getAttribute('cx') + ' ' + p1.getAttribute('cy') +
    'Q' + p2.getAttribute('cx') + ' ' + p2.getAttribute('cy') +
    ' ' + p3.getAttribute('cx') + ' ' + p3.getAttribute('cy'));
}

function onMouseUp(ev) {
  dragElem = null;
}






var canvasScope = document.getElementById('scope');
var canvasSpectrum = document.getElementById('spectrum');
fitToContainer(canvasScope);
fitToContainer(canvasSpectrum);

function fitToContainer(canvas){
  // Make it visually fill the positioned parent
  canvas.style.width ='100%';
  //canvas.style.height='40%';
  // ...then set the internal size to match
  canvas.width  = canvas.offsetWidth;
  //canvas.height = canvas.offsetHeight;
}

var analyser = window.parent.csound.Csound.getaudioAnalyser();

analyser.fftSize = 2048;


var scopeCtx = document.getElementById('scope').getContext('2d');
var spectCtx = document.getElementById('spectrum').getContext('2d');

draw();


function draw() {
  drawSpectrum(analyser, spectCtx);
  drawScope(analyser, scopeCtx);

  requestAnimationFrame(draw);
}

function drawSpectrum(analyser, ctx) {
  var width = ctx.canvas.width;
  var height = ctx.canvas.height;
  var freqData = new Uint8Array(analyser.frequencyBinCount);
  var scaling = height / 256;

  analyser.getByteFrequencyData(freqData);

  ctx.fillStyle = 'rgba(240, 242, 230, 0.1)';
  ctx.fillRect(0, 0, width, height);

  ctx.lineWidth = 2;
  ctx.strokeStyle = 'rgb(128,204,208)';
  ctx.beginPath();

  for (var x = 0; x < width; x++)
    ctx.lineTo(x, height - freqData[x] * scaling);

  ctx.stroke();
}

function drawScope(analyser, ctx) {
  var width = ctx.canvas.width;
  var height = ctx.canvas.height;
  var timeData = new Uint8Array(analyser.frequencyBinCount);
  var scaling = height / 256;
  var risingEdge = 0;
  var edgeThreshold = 5;

  analyser.getByteTimeDomainData(timeData);

  ctx.fillStyle = 'rgba(240, 242, 230, 0.1)';
  ctx.fillRect(0, 0, width, height);

  ctx.lineWidth = 2;
  ctx.strokeStyle = 'rgb(128,204,208)';
  ctx.beginPath();

  // No buffer overrun protection
  while (timeData[risingEdge++] - 128 > 0 && risingEdge <= width);
  if (risingEdge >= width) risingEdge = 0;

  while (timeData[risingEdge++] - 128 < edgeThreshold && risingEdge <= width);
  if (risingEdge >= width) risingEdge = 0;

  for (var x = risingEdge; x < timeData.length && x - risingEdge < width; x++)
    ctx.lineTo(x - risingEdge, height - timeData[x] * scaling);

  ctx.stroke();
}








window.parent.csound.stop();



// attach callbacks to sliders
function attachListeners() {
   document.getElementById("amp").addEventListener("input",SetAmp);
}



// set amplitude
function SetAmp(){
  SetParam('amp');
}



// set parameter
function SetParam(name) {
  var val = document.getElementById(name).value;
  window.parent.csound.setControlChannel(name, val);
}

function pause() {
   var txt = `
   <CsoundSynthesizer>

   <CsInstruments>

   0dbfs = 1
   giSine       ftgen 1, 0, 16384, 10, 1
   giEnv        ftgen 2, 0, 8, -2, 0
   
   instr 1
     kamp chnget  "amp"
     

     kAmp table 2, giEnv, 0
     kfrDev table 3, giEnv, 0
     
     kAmp   port    kAmp, 0.01
     kfrDev   port   kfrDev, 0.01
     
     asig poscil kAmp, 880*(1-kfrDev), 1
           out   asig
    endin
   </CsInstruments>
   <CsScore>
   </CsScore>
   </CsoundSynthesizer>
  `
  window.parent.csound.stop();
  window.parent.csound.Csound.setOption("-r" + window.parent.csound.Csound.getaudioContext().sampleRate);
  window.parent.csound.CompileCsdText(txt);
  
  window.parent.csound.Event("i 1 0 -1");
   
  SetParam("amp");
  window.parent.csound.Csound.setTable(2,2,p2.getAttribute('cx')/300);
  window.parent.csound.Csound.setTable(2,3,p2.getAttribute('cy')/300);
  window.parent.csound.Play();
  window.parent.csound.started=true;
 
}
attachListeners();
</script>
</body> </html>

